<div class="max-w-6xl mx-auto mt-10 px-4">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- (2/3) -->
    <div class="md:col-span-3">
      <div
        class="max-w-3xl mt-20 mx-auto p-6 bg-primary-100 rounded-2xl shadow-lg"
      >
        <h2 class="text-2xl font-bold text-text-700 mb-6">
          Create Certificate
        </h2>

        <form
          [formGroup]="form"
          (ngSubmit)="submit()"
          class="grid grid-cols-1 md:grid-cols-2 gap-4"
        >
          <div>
            <label
              for="commonName"
              class="block text-sm font-medium text-text-600 mb-1"
              >Common name</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Common Name"
              formControlName="commonName"
            />
            <p
              *ngIf="isInvalid('commonName')"
              class="text-red-500 text-sm mt-1"
            >
              Common Name is required
            </p>
          </div>

          <div>
            <label
              for="surname"
              class="block text-sm font-medium text-text-600 mb-1"
              >Surname</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Surname"
              formControlName="surname"
            />
            <p *ngIf="isInvalid('surname')" class="text-red-500 text-sm mt-1">
              Surname is required
            </p>
          </div>

          <div>
            <label
              for="givenName"
              class="block text-sm font-medium text-text-600 mb-1"
              >Given name</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Given Name"
              formControlName="givenName"
            />
            <p *ngIf="isInvalid('givenName')" class="text-red-500 text-sm mt-1">
              Given Name is required
            </p>
          </div>

          <div>
            <label
              for="organization"
              class="block text-sm font-medium text-text-600 mb-1"
            >Organization</label
            >
            <input
              type="text"
              placeholder="Organization"
              class="input w-full border p-2"
              formControlName="organization"
              [matAutocomplete]="auto"
            />
            <mat-autocomplete #auto="matAutocomplete">
              <mat-option *ngFor="let org of organizations" [value]="org.name">
                {{ org.name }}
              </mat-option>
            </mat-autocomplete>
            <p *ngIf="isInvalid('organization')" class="text-red-500 text-sm mt-1">
              Organization is required
            </p>
          </div>


          <div>
            <label
              for="organizationalUnit"
              class="block text-sm font-medium text-text-600 mb-1"
              >Organization unit</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Organizational Unit"
              formControlName="organizationalUnit"
            />
            <p
              *ngIf="isInvalid('organizationalUnit')"
              class="text-red-500 text-sm mt-1"
            >
              Organizational Unit is required
            </p>
          </div>

          <div>
            <label
              for="country"
              class="block text-sm font-medium text-text-600 mb-1"
              >Country</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Country"
              formControlName="country"
            />
            <p *ngIf="isInvalid('country')" class="text-red-500 text-sm mt-1">
              Country is required
            </p>
          </div>

          <div>
            <label
              for="email"
              class="block text-sm font-medium text-text-600 mb-1"
              >Email</label
            >
            <input
              class="input w-full border p-2"
              placeholder="Email"
              type="email"
              formControlName="email"
            />
            <p *ngIf="isInvalid('email')" class="text-red-500 text-sm mt-1">
              Valid email is required
            </p>
          </div>

          <!-- Dropdown korisnici -->
          <div>
            <label
              for="userId"
              class="block text-sm font-medium text-text-600 mb-1"
              >Owner</label
            >
            <select class="input" formControlName="userId">
              <option [ngValue]="null" disabled>Select User</option>
              <option *ngFor="let u of users" [ngValue]="u.id">
                {{ u.firstName }} - {{ u.organizationName }}
              </option>
            </select>
          </div>

          <!-- Date fields -->
          <div class="mb-4">
            <label
              for="validFrom"
              class="block text-sm font-medium text-text-600 mb-1"
              >Start Date</label
            >
            <input
              id="validFrom"
              type="date"
              class="input w-full border p-2"
              formControlName="validFrom"
            />
            <p *ngIf="isInvalid('validFrom')" class="text-red-500 text-sm mt-1">
              Start date is required
            </p>
          </div>

          <div class="mb-4">
            <label
              for="validTo"
              class="block text-sm font-medium text-text-600 mb-1"
              >End Date</label
            >
            <input
              id="validTo"
              type="date"
              class="input w-full border p-2"
              formControlName="validTo"
            />
            <p *ngIf="isInvalid('validTo')" class="text-red-500 text-sm mt-1">
              End date is required
            </p>
          </div>

          <p
            *ngIf="form.errors?.['startNotFuture']"
            class="text-red-500 text-sm"
          >
            Start date must be in the future.
          </p>
          <p *ngIf="form.errors?.['endNotFuture']" class="text-red-500 text-sm">
            End date must be in the future.
          </p>
          <p
            *ngIf="form.errors?.['endBeforeStart']"
            class="text-red-500 text-sm"
          >
            End date must be after start date.
          </p>

          <!-- Tip sertifikata -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-text-600 mb-1"
              >Certificate type</label
            >
            <select class="input col-span-2" formControlName="certificateType">
              <option disabled>Select Certificate type</option>
              <option>RootCA</option>
              <option>CA</option>
              <option>EndEntity</option>
            </select>
          </div>

          <p
            *ngIf="
              form.get('certificateType')?.touched &&
              form.get('certificateType')?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Certificate type is required
          </p>

          <!-- Parent cert dropdown -->
          <div
            *ngIf="
              form.get('certificateType')?.value === 'CA' ||
              form.get('certificateType')?.value === 'EndEntity'
            "
            class="col-span-2"
          >
            <label class="block text-sm font-medium text-text-600 mb-1"
              >Parent Certificate</label
            >
            <select class="input w-full" formControlName="certificateId">
              <option [ngValue]="null" disabled>Select Certificate</option>
              <option
                *ngFor="let c of existingCerts"
                [ngValue]="c.certificateId"
              >
                {{ c.commonName }}
              </option>
            </select>
            <p
              *ngIf="
                form.get('certificateId')?.touched &&
                form.get('certificateId')?.invalid
              "
              class="text-red-500 text-sm mt-1"
            >
              Parent certificate is required
            </p>
            <p
              *ngIf="existingCerts.length === 0"
              class="text-primary-400 text-sm mt-1"
            >
              There is no parent certificates.
            </p>
          </div>
          <!-- Extensions Section -->
          <div class="col-span-2 mt-6 p-4 bg-primary-50 rounded-xl shadow-md text-center">


            <!-- Root / CA ekstenzije -->
            <div *ngIf="form.get('certificateType')?.value === 'RootCA' || form.get('certificateType')?.value === 'CA'"
                 class="flex flex-col items-center space-y-3" [formGroup]="extensionForm">
              <h5 class="text-lg font-semibold mb-4 text-text-700">Extensions</h5>

              <div>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" formControlName="subjectKeyIdentifier" />
                  <span>Subject Key Identifier</span>
                </label>
              </div>
              <div>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" formControlName="authorityKeyIdentifier" />
                  <span>Authority Key Identifier</span>
                </label>
              </div>
            </div>

            <!-- End-Entity ekstenzije -->
            <div *ngIf="form.get('certificateType')?.value === 'EndEntity'"
                 class="flex flex-col items-center space-y-3" [formGroup]="extensionForm">
              <h5 class="text-lg font-semibold mb-4 text-text-700">Extensions</h5>
              <div>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" formControlName="serverAuth" />
                  <span>Server Authentication</span>
                </label>
              </div>
              <div>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" formControlName="clientAuth" />
                  <span>Client Authentication</span>
                </label>
              </div>
            </div>
          </div>




          <!-- Submit -->
          <div class="col-span-2 mt-4">
            <button
              type="submit"
              class="w-full bg-secondary-500 hover:bg-secondary-600 text-white font-semibold py-2 px-4 rounded-xl"
              [disabled]="form.invalid"
            >
              Create
            </button>
          </div>
        </form>
      </div>
    </div>



    @if (!(isCA$|async)){
      <div class="md:col-span-3 mt-10">
        <div
          class="max-w-md mx-auto p-6 bg-primary-100 rounded-2xl shadow-lg text-center"
        >
          <h2 class="text-xl font-bold text-text-700 mb-4">Organizations</h2>

          <div class="flex gap-2">
            <input
              type="text"
              placeholder="Organization name"
              [formControl]="newOrganization"
              class="input flex-1 border p-2 rounded-md"
            />

            <button
              (click)="addOrganization()"
              class="bg-secondary-500 hover:bg-secondary-600 text-white px-4 py-2 rounded-xl"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    }


    <!-- (1/3)
    <div class="md:col-span-1 mt-20">
      <app-organization-list [organizations]="organizations"></app-organization-list>
    </div>
    -->
    <div class="md:col-span-3 mt-20">
      <app-organization-hierarchy
        [hierarchy]="hierarchyOrgs"
      ></app-organization-hierarchy>
    </div>
  </div>
</div>
